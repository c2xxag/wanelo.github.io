<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/monokai_syntax.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script src="/javascripts/jquery-1.11.0.min.js" async="true"></script>
    <script src="/javascripts/main.js" async="true"></script>
    <title>Really Really Really Deleting SMF Service Instances on Illumos</title>
  </head>

  <body>
    <div id="container">
		<div id="navbar" onlick="document.location='/';" style="width:100%"></div>
	      <div class="inner">

	        <header>
	          
	          <h2 class="post-head"><a href="/">Building Wanelo</a></h2>
	          <hr>
	          <h1>Really Really Really Deleting SMF Service Instances on Illumos</h1>
	          
	        </header>
	        <section id="main_content">


<p>We recently ran into a tricky situation with a custom SMF service we maintain on our Joyent SmartOS hosts. &nbsp;The namespace for the service instance (defined in upstream code) had changed, which meant that as our Chef automation upgraded the service instances to the latest code, we ended up with a lot of duplicate service instances that each had a unique namespace.</p>


<p>After wrestling with the best way to batch delete/reinstall the service (using Chef's <em>knife</em> cli), we found a way to improve our old process.</p>
<p>Normally, we would delete services with something like <em>svccfg delete &lt;service_name&gt;</em>, but this doesn't work well if you need to delete a number of services, especially if they have similar namespaces. &nbsp;Further, we found that running this in a loop against the output of <em>svcs -a -H | grep &lt;service_name&gt;</em>&nbsp;wasn't effective because service configurations could linger even after the service instance had been deleted.</p>
<p><span>Digging into <em>man svccfg</em>, we came up with a way to enumerate services and service configurations more cleanly with <em>svccfg</em>:</span></p>
<pre>for service in $(svccfg list | grep nad); do
  sudo svcadm disable -s $service
done

for instance in $(svccfg list | grep nad); do
  sudo svccfg delete $instance
done</pre>
<p><a href="http://wanelo.com/bixu" target="_blank"><span>Blake</span></a></p>


        </section>

        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'waneloengineeringblog'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        

        <footer>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>


        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-10456646-13', 'wanelo.github.io');
          ga('send', 'pageview');

        </script>

      </div>
    </div>
  </body>
</html>

